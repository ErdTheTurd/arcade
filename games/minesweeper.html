<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Minesweeper</title>
    <link rel="stylesheet" href="../assets/site.css" />
  </head>
  <body>
    <div class="wrapper fade-in">
      <a class="back-link" href="../index.html">Back to Hub</a>
      <div class="page-title">
        <h2>Minesweeper</h2>
        <div class="controls">
          <button id="reset">New Game</button>
          <button id="reveal">Reveal All</button>
        </div>
      </div>

      <div class="game-shell">
        <div class="game-panel">
          <div id="board" class="board"></div>
        </div>
        <div class="game-panel">
          <strong>How to play</strong>
          <div class="note">Left-click to reveal a tile. Right-click (or long press) to flag a mine.</div>
          <div class="note">Clear all safe tiles to win. Use number hints to avoid mines.</div>
          <div class="note" id="status">Mines: 10</div>
        </div>
      </div>
    </div>

    <script>
      const size = 10;
      const mines = 10;
      const boardEl = document.getElementById("board");
      const statusEl = document.getElementById("status");
      const resetBtn = document.getElementById("reset");
      const revealBtn = document.getElementById("reveal");

      let cells = [];
      let revealed = 0;
      let flagged = 0;
      let gameOver = false;

      function makeBoard() {
        boardEl.style.gridTemplateColumns = `repeat(${size}, 32px)`;
        boardEl.innerHTML = "";
        cells = [];
        revealed = 0;
        flagged = 0;
        gameOver = false;

        const positions = Array.from({ length: size * size }, (_, i) => i);
        for (let i = positions.length - 1; i > 0; i -= 1) {
          const j = Math.floor(Math.random() * (i + 1));
          [positions[i], positions[j]] = [positions[j], positions[i]];
        }
        const mineSet = new Set(positions.slice(0, mines));

        for (let i = 0; i < size * size; i += 1) {
          const cell = {
            index: i,
            mine: mineSet.has(i),
            revealed: false,
            flagged: false,
            count: 0,
          };
          cells.push(cell);
        }

        cells.forEach((cell) => {
          if (cell.mine) return;
          const { row, col } = toCoord(cell.index);
          let count = 0;
          for (let r = -1; r <= 1; r += 1) {
            for (let c = -1; c <= 1; c += 1) {
              if (r === 0 && c === 0) continue;
              const idx = toIndex(row + r, col + c);
              if (idx !== null && cells[idx].mine) count += 1;
            }
          }
          cell.count = count;
        });

        cells.forEach((cell) => {
          const div = document.createElement("div");
          div.className = "cell";
          div.dataset.index = cell.index;
          div.addEventListener("click", () => reveal(cell.index));
          div.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            toggleFlag(cell.index);
          });
          boardEl.appendChild(div);
        });
        updateStatus("Mines: 10");
      }

      function toCoord(index) {
        return { row: Math.floor(index / size), col: index % size };
      }

      function toIndex(row, col) {
        if (row < 0 || row >= size || col < 0 || col >= size) return null;
        return row * size + col;
      }

      function reveal(index) {
        if (gameOver) return;
        const cell = cells[index];
        if (cell.revealed || cell.flagged) return;
        const div = boardEl.querySelector(`[data-index='${index}']`);
        cell.revealed = true;
        div.classList.add("revealed");
        if (cell.mine) {
          div.textContent = "X";
          endGame(false);
          return;
        }
        revealed += 1;
        if (cell.count > 0) {
          div.textContent = cell.count;
        } else {
          const { row, col } = toCoord(index);
          for (let r = -1; r <= 1; r += 1) {
            for (let c = -1; c <= 1; c += 1) {
              if (r === 0 && c === 0) continue;
              const idx = toIndex(row + r, col + c);
              if (idx !== null) reveal(idx);
            }
          }
        }
        if (revealed === size * size - mines) endGame(true);
      }

      function toggleFlag(index) {
        if (gameOver) return;
        const cell = cells[index];
        if (cell.revealed) return;
        cell.flagged = !cell.flagged;
        flagged += cell.flagged ? 1 : -1;
        const div = boardEl.querySelector(`[data-index='${index}']`);
        div.classList.toggle("flagged", cell.flagged);
        div.textContent = cell.flagged ? "F" : "";
        updateStatus(`Mines: ${mines - flagged}`);
      }

      function endGame(win) {
        gameOver = true;
        cells.forEach((cell) => {
          if (cell.mine) {
            const div = boardEl.querySelector(`[data-index='${cell.index}']`);
            div.textContent = cell.flagged ? "F" : "M";
            div.classList.add("revealed");
          }
        });
        updateStatus(win ? "You cleared the field!" : "Boom! Try again.");
      }

      function updateStatus(message) {
        statusEl.textContent = message;
      }

      resetBtn.addEventListener("click", makeBoard);
      revealBtn.addEventListener("click", () => {
        cells.forEach((cell) => {
          if (!cell.revealed) reveal(cell.index);
        });
      });

      makeBoard();
    </script>
  </body>
</html>
