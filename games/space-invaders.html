<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Space Invaders</title>
    <link rel="stylesheet" href="../assets/site.css" />
    <style>
      #invaders {
        width: 640px;
        height: 420px;
      }
    </style>
  </head>
  <body>
    <div class="wrapper fade-in">
      <a class="back-link" href="../index.html">Back to Hub</a>
      <div class="page-title">
        <h2>Space Invaders</h2>
        <div class="controls">
          <button id="start">Start</button>
          <button id="reset">Reset</button>
        </div>
      </div>

      <div class="game-shell">
        <canvas id="invaders" width="640" height="420"></canvas>
        <div class="game-panel">
          <strong>How to play</strong>
          <div class="note">Move with Left/Right. Space to shoot.</div>
          <div class="note" id="status">Score: 0</div>
        </div>
      </div>
    </div>

    <script>
      const canvas = document.getElementById("invaders");
      const ctx = canvas.getContext("2d");
      const startBtn = document.getElementById("start");
      const resetBtn = document.getElementById("reset");
      const statusEl = document.getElementById("status");

      let player = { x: 300, y: 380, w: 40, h: 12, speed: 6 };
      let bullets = [];
      let invaders = [];
      let running = false;
      let score = 0;
      let dir = 1;
      let keys = {};

      function setup() {
        invaders = [];
        for (let r = 0; r < 4; r += 1) {
          for (let c = 0; c < 9; c += 1) {
            invaders.push({ x: 80 + c * 50, y: 40 + r * 35, w: 30, h: 20, hit: false });
          }
        }
        bullets = [];
        player.x = 300;
        score = 0;
        dir = 1;
        updateStatus();
      }

      function updateStatus(message) {
        statusEl.textContent = message || `Score: ${score}`;
      }

      function shoot() {
        if (!running) return;
        bullets.push({ x: player.x + player.w / 2, y: player.y, vy: -6 });
      }

      function step() {
        if (!running) return;

        if (keys.ArrowLeft) player.x -= player.speed;
        if (keys.ArrowRight) player.x += player.speed;
        player.x = Math.max(10, Math.min(canvas.width - player.w - 10, player.x));

        bullets.forEach((b) => (b.y += b.vy));
        bullets = bullets.filter((b) => b.y > -20);

        let edge = false;
        invaders.forEach((inv) => {
          if (inv.hit) return;
          inv.x += dir * 1.2;
          if (inv.x < 20 || inv.x + inv.w > canvas.width - 20) edge = true;
        });
        if (edge) {
          dir *= -1;
          invaders.forEach((inv) => (inv.y += 12));
        }

        bullets.forEach((b) => {
          invaders.forEach((inv) => {
            if (inv.hit) return;
            if (
              b.x > inv.x &&
              b.x < inv.x + inv.w &&
              b.y < inv.y + inv.h &&
              b.y > inv.y
            ) {
              inv.hit = true;
              b.y = -999;
              score += 10;
            }
          });
        });

        if (invaders.every((inv) => inv.hit)) {
          running = false;
          updateStatus("You cleared the fleet!");
        }

        if (invaders.some((inv) => !inv.hit && inv.y + inv.h > player.y - 10)) {
          running = false;
          updateStatus("Invaders landed. Reset?");
        }

        draw();
        updateStatus();
        requestAnimationFrame(step);
      }

      function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.fillStyle = "#0b0f1f";
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        ctx.fillStyle = "#00d4ff";
        invaders.forEach((inv) => {
          if (inv.hit) return;
          ctx.fillRect(inv.x, inv.y, inv.w, inv.h);
        });

        ctx.fillStyle = "#ffd166";
        ctx.fillRect(player.x, player.y, player.w, player.h);

        ctx.fillStyle = "#ff6a3d";
        bullets.forEach((b) => ctx.fillRect(b.x - 2, b.y - 8, 4, 8));
      }

      document.addEventListener("keydown", (event) => {
        keys[event.key] = true;
        if (event.key === " ") shoot();
      });
      document.addEventListener("keyup", (event) => {
        keys[event.key] = false;
      });

      startBtn.addEventListener("click", () => {
        if (!running) {
          running = true;
          requestAnimationFrame(step);
        }
      });

      resetBtn.addEventListener("click", () => {
        running = false;
        setup();
        draw();
      });

      setup();
      draw();
    </script>
  </body>
</html>
